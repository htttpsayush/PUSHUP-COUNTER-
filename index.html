<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYUSH PUSHUP COUNTER - MediaPipe Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>

    <style>
        /* Styles from pushup2.html */
        .form-dot {
            box-shadow: 0 0 20px currentColor;
        }
        #camera-feed {
            /* Flip video horizontally for mirror effect */
            transform: scaleX(-1);
        }
        .angle-indicator {
            transition: all 0.3s ease;
        }
        /* MediaPipe uses canvas to draw over the video, so keep video hidden when MP is running */
        .video-hidden {
            visibility: hidden;
            position: absolute;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <div id="vanta-bg" class="fixed inset-0 -z-10"></div>

    <header class="bg-gray-800 bg-opacity-80 backdrop-blur-md py-4 px-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i data-feather="activity" class="mr-2 text-purple-500"></i>
                PushUp <span class="text-purple-500">Counter</span>
            </h1>
            <div class="flex space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition">
                    <i data-feather="moon"></i>
                </button>
                <button id="help-btn" class="p-2 rounded-full bg-purple-600 hover:bg-purple-500 transition">
                    <i data-feather="help-circle"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center">
        <div class="bg-gray-800 bg-opacity-70 rounded-2xl p-6 mb-8 w-full max-w-2xl text-center backdrop-blur-sm border border-gray-700 shadow-xl">
            <h2 class="text-xl mb-2 text-gray-300">Push-Up Count</h2>
            <div id="counter" class="text-8xl font-bold text-purple-400 mb-4">0</div>
            
            <div class="flex justify-center space-x-8 mb-6">
                <div class="text-center">
                    <div class="text-2xl font-mono" id="timer">00:00:00</div>
                    <div class="text-gray-400 text-sm">Workout Time</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-mono" id="ppm">0</div>
                    <div class="text-gray-400 text-sm">PPM</div>
                </div>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button id="start-btn" class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-full font-medium flex items-center transition">
                    <i data-feather="play" class="mr-2"></i> Start
                </button>
                <button id="stop-btn" disabled class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-full font-medium flex items-center transition opacity-50">
                    <i data-feather="pause" class="mr-2"></i> Stop
                </button>
                <button id="reset-btn" class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-full font-medium flex items-center transition">
                    <i data-feather="rotate-ccw" class="mr-2"></i> Reset
                </button>
            </div>
        </div>

        <div class="relative w-full max-w-4xl aspect-video bg-black rounded-xl overflow-hidden border-2 border-gray-700 shadow-lg">
            <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video>
            <canvas id="pose-canvas" class="absolute inset-0 w-full h-full"></canvas>
            
            <div id="form-feedback" class="absolute top-4 right-4 flex items-center hidden">
                <div id="form-dot" class="w-4 h-4 rounded-full form-dot mr-2"></div>
                <span id="form-message" class="text-sm font-medium"></span>
            </div>
            
            <div id="angle-indicator" class="absolute bottom-4 left-4 bg-gray-800 bg-opacity-70 px-3 py-2 rounded-full angle-indicator hidden">
                <span class="text-sm">Elbow Angle: <span id="angle-value" class="font-mono">0</span>°</span>
            </div>
        </div>

        <div class="mt-8 bg-gray-800 bg-opacity-70 rounded-xl p-6 w-full max-w-4xl backdrop-blur-sm border border-gray-700">
             <h3 class="text-xl font-bold mb-4 flex items-center">
                <i data-feather="info" class="mr-2 text-purple-500"></i> Form Tips
             </h3>
             <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <li class="flex items-start">
                    <i data-feather="check-circle" class="text-green-400 mr-2 mt-1"></i>
                    <span>Keep your body straight from head to heels</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="check-circle" class="text-green-400 mr-2 mt-1"></i>
                    <span>Lower until elbows are at 90° angles</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="check-circle" class="text-green-400 mr-2 mt-1"></i>
                    <span>Push up until arms are fully extended</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="check-circle" class="text-green-400 mr-2 mt-1"></i>
                    <span>Keep elbows close to your body</span>
                </li>
             </ul>
        </div>
    </main>

    <footer class="bg-gray-800 bg-opacity-80 py-4 px-6 backdrop-blur-md">
        <div class="container mx-auto text-center text-gray-400 text-sm">
            <p>PushUp Counter © 2025 - Your personalized counter</p>
        </div>
    </footer>

    <audio id="count-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>

    <script>
        // --- VARIABLES & SETUP (Combined from both files) ---
        
        let pushUpCount = 0; // Use 'pushUpCount' for consistency with pushup2.html, initialized to 0
        let isDownPosition = false; // State variable for counting (from both files)
        let isCounting = false; // Control flag from pushup2.html
        
        // Timer variables from pushup2.html (needed for start/stop/reset logic)
        let startTime = null;
        let timerInterval = null;
        let totalPauseDuration = 0;
        let pauseStart = null;
        
        // DOM Elements (Updated IDs to match pushup2.html)
        const video = document.getElementById('camera-feed'); 
        const canvas = document.getElementById('pose-canvas'); 
        const ctx = canvas.getContext('2d');
        const counterElement = document.getElementById('counter'); // For pushUpCount display
        
        // UI Elements from pushup2.html
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const timerElement = document.getElementById('timer');
        const ppmElement = document.getElementById('ppm');
        const angleIndicator = document.getElementById('angle-indicator');
        const angleValue = document.getElementById('angle-value');
        const formFeedback = document.getElementById('form-feedback');
        const formDot = document.getElementById('form-dot');
        const formMessage = document.getElementById('form-message');
        const countSound = document.getElementById('count-sound');

        // Vanta.js background setup
        VANTA.WAVES({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x2b1b3a,
            shininess: 35.00,
            waveHeight: 15.00,
            waveSpeed: 0.75,
            zoom: 0.85
        });
        feather.replace();


        // --- CORE PUSH-UP LOGIC & MEDIA PIPE FUNCTIONS ---

        /**
         * Helper function to calculate the angle between three points (a, b, c).
         * @param {Object} a - First landmark point.
         * @param {Object} b - Middle landmark point (the elbow).
         * @param {Object} c - Third landmark point.
         * @returns {number} Angle in degrees.
         */
        function calculateAngle(a, b, c) {
            // Uses the more precise implementation from pushup2.html
            const radians = Math.atan2(c.y - b.y, c.x - b.x) -
                            Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            return angle;
        }

        // Simple feedback function
        function showFormFeedback(type, message) {
            formFeedback.classList.remove('hidden');
            formMessage.textContent = message;

            formDot.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');

            if (type === 'good') {
                formDot.classList.add('bg-green-500');
                formDot.style.boxShadow = '0 0 20px #10b981'; 
            } else if (type === 'bad') {
                formDot.classList.add('bg-red-500');
                formDot.style.boxShadow = '0 0 20px #ef4444';
            } else { // neutral
                formDot.classList.add('bg-yellow-500');
                formDot.style.boxShadow = '0 0 20px #f59e0b';
            }
        }


        function onResults(results) {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Video drawing and flipping logic from pushup2.html
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            if (results.poseLandmarks) {
                // Drawing landmarks (Colors from pushup2.html)
                drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#8b5cf6', lineWidth: 2});
                drawLandmarks(ctx, results.poseLandmarks, {color: '#ff007f', lineWidth: 2, radius: 5});

                if (isCounting) {
                    // Get landmarks for Right Shoulder (12), Elbow (14), and Wrist (16)
                    const s = results.poseLandmarks[12];
                    const e = results.poseLandmarks[14];
                    const w = results.poseLandmarks[16];
                    
                    // Visibility Check (from pushup2.html)
                    if (s.visibility < 0.5 || e.visibility < 0.5 || w.visibility < 0.5) {
                        showFormFeedback('error', 'Cannot clearly see arm joints. Adjust camera/lighting.');
                        angleIndicator.classList.add('hidden');
                        return;
                    }
                    
                    const elbowAngle = calculateAngle(s, e, w);
                    
                    angleIndicator.classList.remove('hidden');
                    angleValue.textContent = Math.round(elbowAngle);
                    showFormFeedback('neutral', 'Tracking Elbow...');

                    // --- SIMPLE COUNTING LOGIC (From push.html) ---
                    // Note: This logic is simpler than pushup2.html's state machine, 
                    // but it was requested to use the logic from the first file.
                    
                    const MIN_DOWN_ANGLE = 90; // Depth hit threshold
                    const MIN_UP_ANGLE = 160; // Rep completion threshold
                    
                    // 1. Going DOWN: If angle is less than 90, set the DOWN state.
                    if (elbowAngle < MIN_DOWN_ANGLE) { 
                        isDownPosition = true;
                        showFormFeedback('good', 'DOWN: Go up now!');
                    } 
                    
                    // 2. Going UP: If in DOWN state AND angle is more than 160, count rep.
                    if (isDownPosition && elbowAngle > MIN_UP_ANGLE) {
                        pushUpCount++;
                        counterElement.textContent = pushUpCount;
                        isDownPosition = false; // Reset state
                        countSound.play();
                        showFormFeedback('good', 'Counted! Rep completed.');
                    }
                }
            }
        }

        // MediaPipe Initialization
        const mpPose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
        mpPose.setOptions({
            modelComplexity: 1, 
            smoothLandmarks: true, 
            minDetectionConfidence: 0.5, 
            minTrackingConfidence: 0.5
        });
        mpPose.onResults(onResults);

        let mpCamera = null;
        let isCameraRunning = false;

        // --- TIMER FUNCTIONS (From pushup2.html) ---
        function updateTimer() {
            const elapsedTime = Date.now() - startTime - totalPauseDuration;
            const totalSeconds = Math.floor(elapsedTime / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            timerElement.textContent = `${hours}:${minutes}:${seconds}`;

            if (totalSeconds > 0) {
                const ppm = Math.round((pushUpCount / totalSeconds) * 60);
                ppmElement.textContent = ppm;
            }
        }

        function startTimer() {
            if (!startTime) {
                startTime = Date.now();
            } else if (pauseStart) {
                totalPauseDuration += Date.now() - pauseStart;
                pauseStart = null;
            }
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            pauseStart = Date.now(); 
        }

        // --- CAMERA/STREAM SETUP (Modified from pushup2.html) ---
        async function initCamera() {
            if (isCameraRunning) {
                mpCamera.start();
                return true;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // Set canvas size to video size for accurate drawing
                        canvas.width = video.videoWidth; 
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
                
                mpCamera = new Camera(video, {
                    onFrame: async () => {
                        await mpPose.send({image: video});
                    },
                    width: video.videoWidth,
                    height: video.videoHeight
                });
                
                mpCamera.start();
                isCameraRunning = true;
                video.classList.add('video-hidden'); // Hide video when canvas takes over
                return true;

            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Could not access camera. Please make sure you've granted camera permissions.");
                return false;
            }
        }


        // --- EVENT LISTENERS (From pushup2.html) ---
        
        startBtn.addEventListener('click', async () => {
            if (isCounting) return;

            isCounting = true;
            
            // UI: Initializing
            startBtn.disabled = true;
            stopBtn.disabled = true;
            startBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
            startBtn.classList.add('bg-gray-600', 'hover:bg-gray-600');
            startBtn.innerHTML = '<i data-feather="loader" class="mr-2 animate-spin"></i> Initializing...';
            feather.replace();

            const cameraSuccess = await initCamera(); 

            if (!cameraSuccess) {
                isCounting = false;
                // UI reset after failure
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-600', 'hover:bg-gray-600');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                startBtn.innerHTML = '<i data-feather="play" class="mr-2"></i> Start';
                feather.replace();
                return;
            }

            startTimer();
            
            // UI: Running
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50');

            startBtn.classList.remove('bg-gray-600', 'hover:bg-gray-600');
            startBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
            startBtn.innerHTML = '<i data-feather="activity" class="mr-2"></i> Running';
            feather.replace();
        });

        stopBtn.addEventListener('click', () => {
            if (!isCounting) return;

            isCounting = false;
            stopTimer();
            if (mpCamera) {
                mpCamera.stop();
            }
            
            // UI: Paused
            startBtn.disabled = false;
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50');
            
            startBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            startBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
            startBtn.innerHTML = '<i data-feather="play" class="mr-2"></i> Resume';
            feather.replace();
        });

        resetBtn.addEventListener('click', () => {
            isCounting = false;
            stopTimer();
            
            pushUpCount = 0;
            startTime = null;
            totalPauseDuration = 0;
            pauseStart = null;
            isDownPosition = false;

            counterElement.textContent = '0';
            timerElement.textContent = '00:00:00';
            ppmElement.textContent = '0';
            
            // UI: Reset
            startBtn.disabled = false;
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50');

            startBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            startBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
            startBtn.innerHTML = '<i data-feather="play" class="mr-2"></i> Start';
            feather.replace();

            // Stop and clean camera stream
            if (mpCamera && video.srcObject) {
                mpCamera.stop();
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                isCameraRunning = false;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            video.classList.remove('video-hidden'); 
            formFeedback.classList.add('hidden');
            angleIndicator.classList.add('hidden');
        });

        // Dummy logic for theme/help buttons (from pushup2.html)
        document.getElementById('theme-toggle').addEventListener('click', () => { console.log("Theme toggle clicked"); });
        document.getElementById('help-btn').addEventListener('click', () => {
            alert("AYUSH PUSHUP COUNTER Help: Ensure full body is visible. The counter tracks the elbow angle (160° UP, 90° DOWN) for a rep.");
        });
    </script>
</body>
</html>